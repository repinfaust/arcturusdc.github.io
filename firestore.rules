rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- Helpers ---------- */
    function authed() { return request.auth != null; }
    function isTsOrIso(x) { return x is timestamp || x is string; }
    function isNullOrStr(x) { return x == null || x is string; }
    function inArray(v, arr) { return arr.hasAll([v]); }

    // Super admin helper
    function isSuperAdmin() {
      return authed() && (
        request.auth.token.email == 'repinfaust@gmail.com' ||
        request.auth.token.email == 'daryn.shaxted@gmail.com'
      );
    }

    // Check if user belongs to a tenant (workspace)
    function inTenant(tenantId) {
      let membershipId = request.auth.token.email + '_' + tenantId;
      let membership = /databases/$(database)/documents/tenant_members/$(membershipId);
      return authed() && exists(membership) &&
        get(membership).data.status == 'active';
    }

    // Check if user can access resource's tenant
    function canAccessTenant(tenantId) {
      return isSuperAdmin() || inTenant(tenantId);
    }

    // Membership helper: require auth, project exists, and user is owner or in members
    function inProject(projectId) {
      let p = /databases/$(database)/documents/projects/$(projectId);
      return authed() && exists(p) && (
        get(p).data.ownerUid == request.auth.uid ||
        (('members' in get(p).data) && get(p).data.members.hasAny([request.auth.uid]))
      );
    }

    /* ---------- Validators for Tou.me testing ---------- */
    function isValidResult() {
      return request.resource.data.keys().hasAll(
               ['testId','status','timestamp','tester','build','platform','notes']
             ) &&
             request.resource.data.testId is string &&
             inArray(request.resource.data.status, ['pass','fail','skip']) &&
             isTsOrIso(request.resource.data.timestamp) &&
             isNullOrStr(request.resource.data.tester) &&
             isNullOrStr(request.resource.data.build) &&
             isNullOrStr(request.resource.data.platform) &&
             isNullOrStr(request.resource.data.notes);
    }

    function isValidSession() {
      return request.resource.data.keys().hasAll(
               ['tester','build','platform','timestamp','testResults','summary','generalFeedback']
             ) &&
             isNullOrStr(request.resource.data.tester) &&
             isNullOrStr(request.resource.data.build) &&
             isNullOrStr(request.resource.data.platform) &&
             isTsOrIso(request.resource.data.timestamp) &&
             (request.resource.data.testResults is map || request.resource.data.testResults is list) &&
             request.resource.data.summary.total is number &&
             request.resource.data.summary.passed is number &&
             request.resource.data.summary.failed is number &&
             request.resource.data.summary.skipped is number &&
             isNullOrStr(request.resource.data.generalFeedback);
    }

    /* ==========================================================
       Multi-tenant collections management
       ========================================================== */
    match /tenants/{tenantId} {
      // Super admins can manage all tenants (read includes get+list)
      allow read, write: if isSuperAdmin();

      // Members can read their own tenants
      allow get: if inTenant(tenantId);
    }

    match /tenant_members/{membershipId} {
      // Super admins can manage all memberships (read includes get+list)
      allow read, write: if isSuperAdmin();

      // Users can read their own memberships
      allow get: if authed() &&
        resource.data.userEmail == request.auth.token.email;

      // Allow users to list their own memberships (for querying by email)
      allow list: if authed();

      // Tenant admins can manage members in their tenant
      allow create, update, delete: if authed() &&
        exists(/databases/$(database)/documents/tenant_members/$(request.auth.token.email + '_' + resource.data.tenantId)) &&
        get(/databases/$(database)/documents/tenant_members/$(request.auth.token.email + '_' + resource.data.tenantId)).data.role == 'admin';
    }

    /* ==========================================================
       STEa board (with tenant isolation - migration-friendly)
       Allow access to legacy data without tenantId OR new data with tenantId check
       ========================================================== */
    match /stea_epics/{epicId} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update, delete: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );

      match /comments/{cid} {
        allow read, create, delete: if authed();
      }
    }

    match /stea_features/{featureId} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update, delete: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );

      match /comments/{cid} {
        allow read, create, delete: if authed();
      }
    }

    match /stea_cards/{doc} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update, delete: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );

      match /comments/{cid} {
        allow read, create, delete: if authed();
      }
    }

    /* ==========================================================
       Automated testing + CI (migration-friendly)
       ========================================================== */
    match /automated_test_runs/{doc} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
    }
    match /automated_test_issues/{doc} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
    }

    match /testRuns/{runId} {
      allow read: if authed();   // dashboard watch (consider adding tenant isolation)
      allow write: if false;     // CI writes via Admin SDK only
    }

    /* Tou.me testing collections (migration-friendly) */
    match /toume_test_results/{doc} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && isValidResult() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update, delete: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
    }
    match /toume_test_sessions/{doc} {
      allow read: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
      allow create: if authed() && isValidSession() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );
      allow update, delete: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );
    }

    /* ==========================================================
       Hans Testing Suite (migration-friendly)
       ========================================================== */
    match /hans_cases/{caseId} {
      // Authenticated users can access legacy data OR tenant data they have access to
      allow read, update, delete: if authed() && (
        !('tenantId' in resource.data) || canAccessTenant(resource.data.tenantId)
      );

      // Creation allows legacy (no tenantId) OR with tenant access
      allow create: if authed() && (
        !request.resource.data.keys().hasAny(['tenantId']) ||
        canAccessTenant(request.resource.data.tenantId)
      );

      // Subcollection: submissions from testers
      match /submissions/{submissionId} {
        // Authenticated users can read submissions
        allow read: if authed();

        // Public can create submissions (testers don't need auth)
        // Validation happens in the API
        allow create: if true;

        // Only authenticated users can update/delete
        allow update, delete: if authed();
      }
    }

    /* ==========================================================
       Product Lab (Felix)
       ========================================================== */
    match /projects/{projectId} {
      // Create: owner = self and self included in members
      allow create: if authed()
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.members.hasAny([request.auth.uid]);

      // Allow bootstrap GET if doc doesn't exist; otherwise require membership
      allow get: if !exists(/databases/$(database)/documents/projects/$(projectId)) || inProject(projectId);

      // Update / delete only for members/owner
      allow update, delete: if inProject(projectId);

      // Subcollection: whiteboards (board doc holds tldrawSnapshot field)
      match /whiteboards/{boardId} {
        allow read, write: if inProject(projectId);

        // Sidebar: Jobs to be done / Questions
        match /jobs/{jobId} {
          allow read, write: if inProject(projectId);
        }

        // If you later persist TLDraw shapes per element
        match /elements/{elementId} {
          allow read, write: if inProject(projectId);
        }
      }

      // Subcollection: stories
      match /stories/{storyId} {
        allow read, write: if inProject(projectId);
      }

      // Subcollection: specs (optional)
      match /specs/{specId} {
        allow read, write: if inProject(projectId);
      }

      // Subcollection: presence (only self can write)
      match /presence/{uid} {
        allow read: if inProject(projectId);
        allow write: if inProject(projectId) && authed() && request.auth.uid == uid;
      }
    }

    /* ==========================================================
       User profiles, badges, metrics
       ========================================================== */
    match /users/{uid} {
      // Self-only profile access
      allow read, create, update: if authed() && request.auth.uid == uid;

      match /badges/{badgeId} {
        allow read, create, update, delete: if authed() && request.auth.uid == uid;
      }

      match /metrics/{docId} {
        allow read: if authed() && request.auth.uid == uid;
        allow create, update: if authed() && request.auth.uid == uid;
        allow delete: if false;
      }
    }
  }
}
